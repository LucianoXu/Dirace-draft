
\newcommand {\cD } {{\mathcal{D}}}
\newcommand {\cl } {{\mathit{cl}}}

% Labelled Dirac Notation

\section{Labelled Dirac Notation}
\label{sec: labelled}



% what is the labelled dirac notation?

% the semantics -- cylinder extension -- uniqueness

% \subsection{Syntax, Typing and Rewriting Rules}

% syntax -- typing -- rules

% \subsection{Normalization}
% normalization -- algorithm that eliminate labels


In this section, we extend the language by allowing quantum variables to indicate the quantum system of vectors and operators it act. 
As discussed, this allows us to express and reason about the states and operations locally, without referring to the whole system. 
We further demonstrate how to transform the equivalence problem into that for the plain Dirac notation studied above.

\subsection{Syntax, Typing and Semantics}
We first introduce the notation of quantum registers for structured variable combinations. This is necessary because, unlike assignments for classical variables, unitary transformations on composite systems--a quantum version of assignments--cannot generally be decomposed into separate unitary transformations on individual subsystems.
Let $\cR$ be the set of quantum variables.
%The first new notion is quantum registers, and we assume they are constructed from a set $\cR$.
\begin{definition}[Quantum Register] Register $R$ is inductively generated by
  \begin{align*}
    R ::= r\in\cR \mid (R, R).
  \end{align*}
\end{definition}
For simplicity, we only allow pairing the registers, which corresponds to the structure of tensor product, i.e., $\cH_{(R_1,R_2)}$ is isomorphic to $\cH_{R_1}\otimes \cH_{R_2}$, which allows us to view the tensor product space as the space of paired registers.

The no-cloning theorem, a fundamental property of quantum computing, prevents us from copying an unknown quantum state. This requires an additional check on the valid registers--they should not include repeated quantum variables--which is often handled in programming languages via linear types. As such, we define the \emph{order-free} variable set of a register as all quantum variables appearing in the register; we let $\var(R)$ denote the variable set of register $R$.
We use the variable set to establish side conditions of typing valid registers and employ it as the type parameter for annotating labelled Dirac terms.

% \begin{definition}
% The variable set of a register is defined inductively by:
% \begin{itemize}
%     \item $\var(R) = \{r\}$, if $R\equiv r$; or
%     \item $\var(R) = \var(R_1) \cup\var(R_2)$, if $R\equiv (R_1,R_2)$.
% \end{itemize}
% \end{definition}

% \textbf{Remark: } Set operations: $\cup$ for union; $\cap$ for intersection; $\setminus$ for difference. So,
% % \begin{itemize}
% $ S_1 \cap S_2 \equiv S_1 \cup S_2 \setminus (S_1 \setminus S_2) \setminus (S_2 \setminus S_1) $.
% \end{itemize}

% The labelled Dirac notation is an extension on the existing type and syntax.
Now, we are ready to extend the type syntax and term syntax as follows:
\begin{definition}[Labelled Dirac Notation]
  The \textbf{labelled Dirac notation} includes all plain Dirac notation symbols and the generators defined below.
  Here, $s\subseteq \cR$ is a quantum variable set.
  \begin{align*}
    T & ::= \DType(s,s) \mid \mathsf{Reg}(\sigma) \\
    e & ::= R \mid |i\>_r \mid {}_r\<i| \mid e_R \mid e_{R;R} \mid
    e \otimes e \otimes \cdots \otimes e \mid e \cdot e.
  \end{align*}
\end{definition}
$\DType(s_1, s_2)$ is the unified type for all labelled Dirac notation, where $s_1$ indicates the codomain systems and $s_2$ indicates the domain systems.
Roughly speaking, we define Hilbert space $\cH_s\triangleq\bigotimes_{r\in s}\cH_r$ for each set $s$, so that $\cH_{\emptyset}$ is a one-dimensional space isomorphic to complex numbers. Then the function view of ket and bra~\cite{Zhou2023} provides an alternative way, i.e., a ket on subsystem $s$ as a linear map from $\cH_{\emptyset}$ to $\cH_s$, a bra as a linear map from $\cH_s$ to $\cH_{\emptyset}$, to unify the type of kets, bras, and operators. For instance, labelled ket $|i\>_r$ has type $\DType(\{r\}, \emptyset)$, and labelled bra ${}_r\<i|$ has type $\DType(\emptyset, \{r\})$.
$\reg(\sigma)$ are types for registers $R$, and the index $\sigma$ indicates the type of Hilbert space represented by the register.
It is allowed to lift a plain Dirac notation associate with corresponding quantum variables or registers, e.g., $\ket{i}_r$ and ${}_r\bra{i}$ are labelled basis, $e_R$ for bra, ket, and $e_{R;R'}$ for operators which additionally allows different domain $R'$ and codomain $R$.
We further introduce new $\cdot$ for generalized composition (unified for all kinds of multiplications between kets, bras and operators) and $\otimes$ for labelled tensor product since they do not share the same properties v.s. its counterpart in plain Dirac notation, i.e., generalized composition is not associative and labelled tensor is indeed an AC symbol.
% In labelled Dirac notation, the structure of tensor product does not matter, therefore $\otimes$ is an AC symbol.
% Following the unified type $\DType(s,s)$, all kinds of multiplications are represented by the same dot product $e \cdot e$.
% Finally, $\ket{i}_r$ and ${}_r\bra{i}$ are labelled basis for the normal form of labelled Dirac notation, where $r$ are registers symbols in $\mathcal{R}$. 

\paragraph*{Typing rules.}
There are various rules for computing types and checking vadility of registers and labelled terms. Here we display some of the rules and see Appendix for all the rest.
\begin{gather*}
  \frac{
      \Gamma \vdash R : \reg(\sigma) \quad
      \Gamma \vdash Q : \reg(\tau)
      \quad \var(R) \cap \var(Q) = \emptyset
  }{\Gamma \vdash (R,Q) : \reg(\sigma \times \tau)} \\[0.2cm]
  \frac{
          \Gamma \vdash r : \reg(\sigma) \quad
          \Gamma \vdash i : \Basis(\sigma)}
  {\Gamma \vdash |i\>_r : \DType(\{r\}, \emptyset)}
  \qquad
  \frac{\Gamma \vdash R : \reg(\sigma)\qquad \Gamma \vdash K : \KType(\sigma)}{\Gamma \vdash K_R : \DType(\var(R), \emptyset)} \\[0.2cm]
    \frac{
        \Gamma \vdash D_i : \DType(s_i,s_i') \qquad
        \forall\,i\neq j.\ s_i\cap s_j = \emptyset \qquad
        \forall\,i\neq j.\ s'_i\cap s'_j = \emptyset
    }
    {\Gamma \vdash D_1 \otimes \cdots \otimes D_i : \DType(\bigcup_i s_i, \bigcup_i s_i')}.
\end{gather*}
The first rule says that a paired register is of the product type and its components should be disjoint.
To lift a plain Dirac notation into the labelled one (line 2), we enforce that the term and register are of the same indices, reflecting the fact the state should be consistant to the corresponding subsystems.
The third line gives the typing of labelled tensoring with a check whether the component subsystems are disjoint with each other.
Since $\cR$ is given, let $\sigma_r : \Index$ denote type of $r$, i.e.,  $\Gamma\vdash r : \reg(\sigma_r)$, for simplicity.

% \[
%     \frac{
%         \begin{aligned}
%             E \vdash D_1 : \DType(s_1,s_1') \\
%             E \vdash D_2 : \DType(s_2,s_2')
%         \end{aligned}
%         \qquad 
%         \begin{aligned}
%             s_1 \cap s_2 \backslash s_1' = \emptyset \\
%             s_2' \cap s_1' \backslash s_2 = \emptyset
%         \end{aligned}
%     }
%     {E \vdash D_1\cdot D_2 : \DType(s_1 \cup (s_2\backslash s_1'), s_2' \cup (s_1'\backslash s_2))}.
% \]

% Some typing rules are introduced here.
% The rule for $\DType(s_1, s_2)$ requires that all registers in variable set $s_1$ and $s_2$ are well-typed.
% The rule for $K_R$ demonstrates how a register label is added to the Dirac notation, and the rule for $D^\dagger$ shows that labelled Dirac notation also have symbols for calculation, such as the adjoint.
% \[
%     \frac{E \vdash  \sigma : \Index}{E \vdash \reg(\sigma) : \Type}
%     \qquad
%     \frac{E \vdash r : \reg(\sigma_r) \text{ for all $r$ in $s_1$ and $s_2$} }{E \vdash \DType(s_1, s_2) : \textsf{Type}} 
% \]
% \[
%     \frac{E \vdash R : \reg(\sigma)\qquad E \vdash K : \KType(\sigma)}{E \vdash K_R : \DType(\var R, \emptyset)}
%     \qquad
%     \frac{E \vdash D : \DType(s_1,s_2)}{E \vdash D^\dagger : \DType(s_2,s_1)}
% \]
% The dot and the tensor product symbols are different from those in unlabelled Dirac notation. Since the goal of labels is to replace the order and structure of tensor products by the reference to registers, the tensor product becomes an AC symbol. The typing still checks whether the component subsystems are disjoint with each other.
% \[
%     \frac{
%         E \vdash D_i : \DType(s_i,s_i') \qquad
%         \bigcap_i s_i = \emptyset \qquad
%         \bigcap_i s_i' = \emptyset
%     }
%     {E \vdash D_1 \otimes \cdots \otimes D_i : \DType(\bigcup_i s_i, \bigcup_i s_i')}.
% \]
% As for the dot product, the disjointness is considered except registers contracted by multiplication.
% \[
%     \qquad
%     \frac{
%         \begin{aligned}
%             E \vdash D_1 : \DType(s_1,s_1') \\
%             E \vdash D_2 : \DType(s_2,s_2')
%         \end{aligned}
%         \qquad 
%         \begin{aligned}
%             s_1 \cap s_2 \backslash s_1' = \emptyset \\
%             s_2' \cap s_1' \backslash s_2 = \emptyset
%         \end{aligned}
%     }
%     {E \vdash D_1\cdot D_2 : \DType(s_1 \cup (s_2\backslash s_1'), s_2' \cup (s_1'\backslash s_2))}.
% \]

\paragraph*{Semantics.} The labelled Dirac notation handles lifting and ordering for us, and its semantics faithfully capture these details. The key points are 1. cylindrical extension that lift a ket or bra or operator to larger domain and codomain; 2. general composition further employs cylindrical extension that obeys the principle of ``localizing objects as much as possible''~\cite{Zhou2023}.

\begin{definition}[Cylindrical Extension]
  For any $D : \cD(s_1,s_2)$ and $s$ that disjoint with both $s_1$ and $s_2$, we define $\cl(D,s) \triangleq D\otimes \mathbf{1}_{s}$ of type $\cD(s_1\cup s, s_2\cup s)$.
\end{definition}
Formally, we equip $\cR$ with a default order, say for example the alphabetical order of names. For any valid register $R$, there exists the operator $\Swap_R$ that sorts $R$; for example, $\Swap_{(q,p)} \triangleq \sum_{i\in \bU(\sigma_p)}\sum_{j\in \bU(\sigma_q)}|i\>\<j|\otimes |j\>\<i|$. We can further define $\Swap_{s_1,s_2,\cdots}$ for merging disjoint sets orderly. See Appendix \ref{sec: full denotational sem} for details.

For given context $\Gamma$ and any valuation $v$,
we interpret 
$$\mbox{$\sem{\cD(s,s')}_v \triangleq \mathcal{L}(\bigotimes_{j}\cH_{\sem{\sigma_{r'_j}}_v}, \bigotimes_{i}\cH_{\sem{\sigma_{r_i}}_v})$}$$ where $\mathcal{L}$ denotes the set of linear maps, 
the sets $s = \{r_1,\cdots,r_n\}$ and $s' = \{r'_1,\cdots,r'_m\}$ ($r_i$ and $r'_j$ are sorted).
% we define $\sigma_s\triangleq \sigma_1\times\cdots\times\sigma_n$ if $s$ is non-empty. \label{context: sigma s}
% For any valuation $v$, we further write $\cH_{\sem{s}_v} \triangleq \bigotimes_{i}\cH_{\sem{\sigma_i}_v}$ which equals to $\cH_{\sem{\sigma_s}_v}$ for non-empty $s$.
% We interpret $\sem{\cD(s,s')} \triangleq \mathcal{L}(\cH_{\sem{s'}_v}, \cH_{\sem{s}_v})$ where $\mathcal{L}$ denotes the set of linear maps.
% for any $s\subseteq \cR$, where $\Gamma\vdash r : \reg(\sigma_r)$ for all $r\in\cR$. 
We interpret labelled Dirac notations inductively as (assume $\Gamma\vdash D_i : \cD(s_i,s'_i)$) :
\begin{itemize}
  \item $\sem{|i\>_r}_v = |\sem{i}_v\>$;\quad 
        $\sem{\<i|_r}_v = \<\sem{i}_v|$;\quad  
        $\sem{K_R}_v = \sem{\Swap_R}_v \cdot \sem{K}_v$; \\
        $\sem{B_R}_v = \sem{B}_v\cdot \sem{\Swap_R}_v$;\quad
        $\sem{O_{R_1,R_2}}_v = \sem{\Swap_{R_1}}_v\cdot \sem{O}_v\cdot \sem{\Swap_{R_2}}_v$;
  \item $\sem{D_1\otimes \cdots \otimes D_n}_v = \sem{\Swap_{s_1,\cdot,s_n}}_v\cdot (\sem{D_1}_v\otimes \cdots \otimes \sem{D_1}_v)\cdot \sem{\Swap_{s'_1,\cdot,s'_n}}_v$;
  \item $\sem{D_1\cdot D_2}_v = \sem{\cl(D_1, s_2\backslash s'_1)}_v\cdot \sem{\cl(D_2, s'_1\backslash s_2)}_v$. Note that $s_2\backslash s'_1$ and $s'_1\backslash s_2$ are the minimal extension that make it interpretable. E.g., to interpret ${}_p\<i|\cdot |j\>_{p,q}$, we at least need to extend ${}_p\<i|$ to ${}_p\<i|\otimes I_{q}$.
\end{itemize}
It can be shown that Lemma \ref{lemma:sound type system} also holds for labelled terms, i.e., $\sem{D}_v \in \sem{\cD(s,s')}_v$ given $\Gamma\vdash D : \cD(s,s')$. Following the semantics, labelled tensor is independent of its order, i.e., $\sem{D_1\otimes D_2}_v = \sem{D_2\otimes D_1}_v$ and $\sem{D_1\otimes (D_2\otimes D_3)}_v = \sem{(D_1\otimes D_2)\otimes D_3}_v$, which ensures the soundness of treating labelled tensor as an AC symbol.

\subsection{Normalization}
The normalization procedure of labelled Dirac notation allows us to eliminate all labels and thus translate the equality of labelled terms to the equality of plain Dirac terms. This is achieved by the following three steps: 

\paragraph*{1. Elimination of $e_R$ or $e_{R;R}$.}
We decompose all $e_R$ or $e_{R;R}$ to the labelled basis with scalar coefficients. 
%We add rules to the term rewriting system, which in general try to represent labelled Dirac notation with labelled basis and scalar coefficients. The first step is the label elimination. 
Take operator as an example:
\begin{align*}
    & O_{R,R'} \ \reduce\ \sum_{i_{r_1}\in\bU(\sigma_{r_1})}\cdots \sum_{i_{r_n}\in\bU(\sigma_{r_n})}
    \sum_{i_{r'_1}\in\bU(\sigma_{r'_1})}\cdots \sum_{i_{r'_{n'}}\in\bU(\sigma_{r'_{n'}})} \\
    & \qquad (\<i_R|\cdot O\cdot |i_{R'}\>).(|i_{r_1}\>_{r_1}\otimes\cdots\otimes|i_{r_n}\>_{r_n} \otimes {}_{r'_1}\<i_{r'_1}|\otimes\cdots\otimes{}_{r'_{n'}}\<i_{r'_{n'}}|).
\end{align*}
where $|i_R\>$ and $\<i_{R'}|$ are constructed by tensoring the basis according to the structure of $R$ (see Appendix \ref{sec: full denotational sem}). The rules for $e_R$ (ket and bra) are similar.
%This step reduces all labelled terms $e_R$ or $e_{R;R}$.

\paragraph*{2. Rewriting to the normal form.}
We add three types of rules for dealing with operators on labeled terms, 1) recursively applying them to subterms, 2) push big operators out and 3) eliminate generalized composition and bra-ket pairs.
%Other symbols on labelled Dirac notation are also 
Take the rule for conjugate $(D_1 \cdot D_2)^\dagger \ \reduce\ D_2^\dagger \cdot D_1^\dagger$ as an example of 1).
For 2), we use distributivity rules for scaling, labelled tensor and generalized composition. For example, rule
\[
% \textrm{(R-SUM-PUSHD0)}
X_1 \otimes \cdots (\sum_{i \in M} D) \cdots \otimes X_2\ \reduce\ \sum_{i \in M} (X_1 \otimes \cdots D \cdots \otimes X_n)
\]
will lift summation to the outside.
Extra rules for 3) are established including:
% The final step operates on sum and dot product. They will lift summation to the outside, and eliminate the bra-ket pairs whenever possible.
\begin{align*}
    % & \textrm{(R-SUM-PUSHD0)}
    % && X_1 \otimes \cdots (\sum_{i \in M} D) \cdots \otimes X_2\ \reduce\ \sum_{i \in M} (X_1 \otimes \cdots D \cdots \otimes X_n) \\
    % %
    % & \textrm{(R-SUM-PUSHD1)}
    % && (\sum_{i \in M} D_1) \cdot D_2 \ \reduce\ \sum_{i \in M} (D_1 \cdot D_2) \\
    %
    & \textrm{(R-L-SORT0)}
    && A : \DType(s_1, s_2), B : \DType(s_1', s_2'), s_2 \cap s_1'=\emptyset \Rightarrow A \cdot B \ \reduce\ A \otimes B \\
    %
    & \textrm{(R-L-SORT1)}
    && {}_r\bra{i}\cdot\ket{j}_r \ \reduce\ \delta_{i, j} \\
    %
    & \textrm{(R-L-SORT2)}
    && {}_r\bra{i}\cdot(Y_1 \otimes \cdots \otimes \ket{j}_r \otimes \cdots \otimes Y_m) \ \reduce\ \delta_{i, j}.(Y_1  \otimes \cdots \otimes Y_m)
    %
\end{align*}
% These rules are added to the rewriting system in~\Cref{sec: decide} and executed together.
Assuming no variables of $\DType(s_1, s_2)$, 
repeating the application of the above rules yield the normal form of both sides of the equality--the addition of big operators: 
\begin{equation}
  \label{eqn:Labelled normal}
  \sum_{i}\cdots\sum_{j} a_1 . (\ket{i}_{p} \otimes \cdots \otimes \bra{j}_{q})
  + \cdots +
  \sum_{k}\cdots\sum_{l} a_m . (\ket{k}_{r} \otimes \cdots \otimes \bra{l}_{s})
\end{equation}
where each sum body is a tensor of labelled basis with scalar coefficients in plain Dirac notation.
\paragraph*{3. Ordering and elimination of quantum variables.} 
We further sort tensors of labelled basis in every sum body of Eqn. (\ref{eqn:Labelled normal}) by 1. ket first and 2. the default order of variables. This yield the same shape of every subterm on both sides of the equality, e.g., 
\begin{equation}
  \label{eqn:Labelled normal1}
  \sum_{i}\cdots\sum_{j}\cdots \sum_{i'}\cdots\sum_{j'} a_1 . ((\ket{i}_p \otimes \cdots \otimes \ket{j}_q) \otimes (\bra{i'}_{p'}\otimes\cdots\otimes \bra{j'}_{q'}))
\end{equation}
and thus it is equivalent to decide the equivalence of additions of subterms of:
\begin{equation}
  \label{eqn:Labelled normal2}
  \sum_{i}\cdots\sum_{j}\cdots \sum_{i'}\cdots\sum_{j'} a_1 . ((\ket{i} \otimes \cdots \otimes \ket{j}) \cdot (\bra{i'}\otimes\cdots\otimes \bra{j'}))
\end{equation}
which do not involve any labels. 

%Define $T_{s,s'}$ as $\SType$ if $s=s'=\emptyset$, $\KType(\sigma_s)$ if $s'=\emptyset$, $\BType(\sigma_{s'})$ if $s=\emptyset$ and $\OType(\sigma_s,\sigma_{s'})$ otherwise (see Sec. \ref{context: sigma s}). We claim the soundness of our normalization as:
% Then if the original equality is $\Gamma\vdash D_1 = D_2 : \cD(s,s')$, what remains to be check $\Gamma\vdash e_1 = e_2 : T_{s,s'}$.
\paragraph*{}
By routinely showing that Lemma \ref{lem: axiom sound} holds for the extra rules mentioned above and in Appendix \ref{sec: rewriting rules} (regard rules as equational theory), we further claim:
\begin{theorem}[Soundness and Completeness of Normalization]
  \label{thm: normalization}
  Assuming $\Gamma\vdash D_1 : \cD(s,s')$, $\Gamma\vdash D_2 : \cD(s,s')$, 
  and no variables of $\DType(\cdot,\cdot)$ in $D_1,D_2$.
  Let $e_1 = e_2$ be obtained by above normalization procedure on $D_1 = D_2$. Then $\Gamma\vDash D_1 = D_2$ if and only if $\Gamma\vDash e_1 = e_2$.
  %All rewriting rules for labelled Dirac notations listed here and in Appendix are sound, i.e., for any interpretation $\sem{\cdot}$, $D\reduce D'$ implies $\sem{D} = \sem{D'}$.
\end{theorem}
% \begin{proof}
%   Notice that all rewriting rules and ordering perserve the types, so the final step eliminating labels is both sound and complete. 
%   It is routinely to check that each rewriting rules and ordering step are sound based on the semantics. This directly leads to the soundness. For completeness, we need further check if the normalization procedure always provide $e_1 = e_2$, i.e., it never gets stuck and terminates. Step 1 is trivial. For step 2, it can be further checked that 1. there is no circular rules and thus terminates, and 2. if it is not in form (\ref{eqn:Labelled normal}), there must exists one of the rules can be further applied. For step 3, ordering is always applicable. This completes the proof.
% \end{proof}

% \begin{theorem}[Completeness of normalization]
%   $E\vDash D_1 = D_2$ only if $E\vDash e_1 = e_2$, assuming that $E\vdash D_1 : \cD(s,s')$, $E\vdash D_2 : \cD(s,s')$, and $e_1 = e_2$ are obtained by above normalization procedure on $D_1 = D_2$.
% \end{theorem}
% \begin{proof}
%   It is sufficient to check if each step achieves its goal. Step 1 is trivial. For step 2, it can be further checked that if it is not in form (\ref{eqn:Labelled normal}), there must exists one of the rules can be further applied.
%   For step 3, realize that all rewriting rules perserve the types, i.e., $D\reduce D'$ then $E\vdash D : \cD(s,s')$ and $E\vdash D : \cD(s,s')$ for some $s,s'\subseteq \cR$, which ensure the same shape of every subterm after sorting. 
% \end{proof}
% , we claim that tensor of labelled basis in every sum body of Eqn. (\ref{eqn:Labelled normal}) are of the same type. As a consequence, by sort the labelled tensors according to a default order of variables, they 

% In this stage, we only need to check the scalars to decide the equivalence of labelled Dirac notation.

% \begin{lemma}[normal form]
%     \label{lem: labelled normal form}
%     For a well-typed term $e$ in $E[\Gamma]$, if $e$ does not contain variables of $\DType(s_1, s_2)$ type, the normal form of $e$ will be
%     \[
%     \sum_{i}\cdots\sum_{j} a_1 . (\ket{i}_{p} \otimes \cdots \otimes \bra{j}_{q})
%     + \cdots +
%     \sum_{k}\cdots\sum_{l} a_m . (\ket{k}_{r} \otimes \cdots \otimes \bra{l}_{s})
%     \]
%     Where $a_i$ are scalar typed Dirac notation.
% \end{lemma}
% \begin{proof}
%     Labelled Dirac notation of $e_R$, $e_R;R$, 
% \end{proof}
